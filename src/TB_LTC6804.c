#include "TB_LTC6804.h"

#define slave_mode 0

//volatile short CRC15_POLY;	//used for PEC calculate
volatile short remainder;		//used for PEC calculate
volatile short address;			//used for PEC calculate

volatile char gCommandType = 1;
unsigned char flgDateUpdate = 0;
volatile char Waittime = 30;
unsigned char openwire = 2;
volatile unsigned char  SPILINE = 0;
unsigned long resettime = 30000;
unsigned char wake_up_counts=0;
unsigned char sendable = 0;
volatile unsigned char g_SPI_Rx_array[51][12] = {0};//SPI接收数据的数组
volatile short pec15Table[256]={
0x0,	0xc599,	0xceab,	0xb32,	0xd8cf,	0x1d56,	0x1664,	0xd3fd,	0xf407,	0x319e,	0x3aac,	0xff35,	0x2cc8,	0xe951,	0xe263,	0x27fa,
0xad97,	0x680e,	0x633c,	0xa6a5,	0x7558,	0xb0c1,	0xbbf3,	0x7e6a,	0x5990,	0x9c09,	0x973b,	0x52a2,	0x815f,	0x44c6,	0x4ff4,	0x8a6d,
0x5b2e,	0x9eb7,	0x9585,	0x501c,	0x83e1,	0x4678,	0x4d4a,	0x88d3,	0xaf29,	0x6ab0,	0x6182,	0xa41b,	0x77e6,	0xb27f,	0xb94d,	0x7cd4,
0xf6b9,	0x3320,	0x3812,	0xfd8b,	0x2e76,	0xebef,	0xe0dd,	0x2544,	0x2be,	0xc727,	0xcc15,	0x98c,	0xda71,	0x1fe8,	0x14da,	0xd143,
0xf3c5,	0x365c,	0x3d6e,	0xf8f7,	0x2b0a,	0xee93,	0xe5a1,	0x2038,	0x7c2,	0xc25b,	0xc969,	0xcf0,	0xdf0d,	0x1a94,	0x11a6,	0xd43f,
0x5e52,	0x9bcb,	0x90f9,	0x5560,	0x869d,	0x4304,	0x4836,	0x8daf,	0xaa55,	0x6fcc,	0x64fe,	0xa167,	0x729a,	0xb703,	0xbc31,	0x79a8,
0xa8eb,	0x6d72,	0x6640,	0xa3d9,	0x7024,	0xb5bd,	0xbe8f,	0x7b16,	0x5cec,	0x9975,	0x9247,	0x57de,	0x8423,	0x41ba,	0x4a88,	0x8f11,
0x57c,	0xc0e5,	0xcbd7,	0xe4e,	0xddb3,	0x182a,	0x1318,	0xd681,	0xf17b,	0x34e2,	0x3fd0,	0xfa49,	0x29b4,	0xec2d,	0xe71f,	0x2286,
0xa213,	0x678a,	0x6cb8,	0xa921,	0x7adc,	0xbf45,	0xb477,	0x71ee,	0x5614,	0x938d,	0x98bf,	0x5d26,	0x8edb,	0x4b42,	0x4070,	0x85e9,
0xf84,	0xca1d,	0xc12f,	0x4b6,	0xd74b,	0x12d2,	0x19e0,	0xdc79,	0xfb83,	0x3e1a,	0x3528,	0xf0b1,	0x234c,	0xe6d5,	0xede7,	0x287e,
0xf93d,	0x3ca4,	0x3796,	0xf20f,	0x21f2,	0xe46b,	0xef59,	0x2ac0,	0xd3a,	0xc8a3,	0xc391,	0x608,	0xd5f5,	0x106c,	0x1b5e,	0xdec7,
0x54aa,	0x9133,	0x9a01,	0x5f98,	0x8c65,	0x49fc,	0x42ce,	0x8757,	0xa0ad,	0x6534,	0x6e06,	0xab9f,	0x7862,	0xbdfb,	0xb6c9,	0x7350,
0x51d6,	0x944f,	0x9f7d,	0x5ae4,	0x8919,	0x4c80,	0x47b2,	0x822b,	0xa5d1,	0x6048,	0x6b7a,	0xaee3,	0x7d1e,	0xb887,	0xb3b5,	0x762c,
0xfc41,	0x39d8,	0x32ea,	0xf773,	0x248e,	0xe117,	0xea25,	0x2fbc,	0x846,	0xcddf,	0xc6ed,	0x374,	0xd089,	0x1510,	0x1e22,	0xdbbb,
0xaf8,	0xcf61,	0xc453,	0x1ca,	0xd237,	0x17ae,	0x1c9c,	0xd905,	0xfeff,	0x3b66,	0x3054,	0xf5cd,	0x2630,	0xe3a9,	0xe89b,	0x2d02,
0xa76f,	0x62f6,	0x69c4,	0xac5d,	0x7fa0,	0xba39,	0xb10b,	0x7492,	0x5368,	0x96f1,	0x9dc3,	0x585a,	0x8ba7,	0x4e3e,	0x450c,	0x8095,
};

volatile unsigned char SPIDATA2[][12]=
	{
		    //1    2    3    4    5    6    7    8    9    10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   27
			//0x80,0x01,0x4D,0x7A,0xFC,0x00,0x00,0x00,0x00,0x00,0x4F,0x82,// WRCFG // 1 // 1 //refon=1
		 	//地址为 0000的6804
			0x80,0x01,0x4D,0x7A,0xF8,0x00,0x00,0x00,0x00,0x00,0xBE,0xE2,// WRCFG // 1 // 1 //
		 	0x83,0x70,0xDF,0x56,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 1 // 4 //
		 	0x80,0x04,0x77,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 1 // 7 //
		 	0x80,0x06,0xEA,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 1 // 8 //
		 	0x80,0x08,0x2E,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 1 // 9 //
		 	0x80,0x0a,0xB3,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 1 // 10 //
		 	0x85,0x60,0xA3,0xB4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCVAX // 1 // 19 //
		 	0x80,0x0c,0x9F,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXA // 1 // 21 //
		 	0x80,0x0e,0x02,0x8E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXB // 1 // 22 //
			0xE5,0x60,0x42,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			//地址为1000的6804
		 	0xC0,0x01,0x75, 0x70,0xF8,0x00,0x00,0x00,0x00,0x00,0xBE,0xE2,// WRCFG // 1 // 1 //
		 	0xC3,0x70,0xE7, 0x5C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 1 // 4 //
		 	0xC0,0x04,0x4F, 0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 1 // 7 //
		 	0xC0,0x06,0xD2, 0x8A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 1 // 8 //
		 	0xC0,0x08,0x16, 0x4C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 1 // 9 //
		 	0xC0,0x0a,0x8B, 0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 1 // 10 //
		 	0xC5,0x60,0x9B, 0xBE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCVAX // 1 // 19 //
		 	0xC0,0x0C,0xA7, 0xD2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXA // 1 // 21 //
		 	0xC0,0x0E,0x3A, 0x84,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXB // 1 // 22 //
			0xE5,0x60,0x42,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

			0x80,0x01,0x4D,0x7A,0xF8,0x00,0x00,0x00,0x00,0x00,0xBE,0xE2,// WRCFG // 1 // 1 //
			0xC0,0x01,0x75,0x70,0xF8,0x00,0x00,0x00,0x00,0x00,0xBE,0xE2,// WRCFG // 2 // 2 //
			0xE0,0x01,0xAC,0xEC,0xF8,0x00,0x00,0x00,0x00,0x00,0xBE,0xE2,// WRCFG // 3 // 3 //

			////0x80,0x02,0x5B,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// WRCFG // 1 // 1 //
			////0xC0,0x02,0x63,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// WRCFG // 2 // 2 //
			////0xE0,0x02,0xBA,0x88,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// WRCFG // 3 // 3 //

		    ////0xE3,0x70,0x3e,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 3 // 6 //
		    0x83,0x70,0xDF,0x56,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 1 // 4 //
		    ///0xC3,0x70,0xE7,0x5C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 2 // 5 //
		    0xC3,0x70,0xE7,0x5C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 2 // 5 //
		    ///0xC3,0x70,0xE7,0x5C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 2 // 5 //
		    0xE3,0x70,0x3e,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 3 // 6 //
		    ////0x83,0x70,0xDF,0x56,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCV // 1 // 4 //

		    ////0xE0,0x04,0x96,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 3 // 15 //
		    ////0xE0,0x06,0x0B,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 3 // 16 //
		    ////0xE0,0x08,0xCF,0xD0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 3 // 17 //
		    ////0xE0,0x0a,0x52,0x86,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 3 // 18 //
		    0x80,0x04,0x77,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 1 // 7 //
		    0x80,0x06,0xEA,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 1 // 8 //
		    0x80,0x08,0x2E,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 1 // 9 //
		    0x80,0x0a,0xB3,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 1 // 10 //
		    ////0xC0,0x04,0x4F,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 2 // 11 //
		    ////0xC0,0x06,0xD2,0x8A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 2 // 12 //
		    ////0xC0,0x08,0x16,0x4C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 2 // 13 //
		    ////0xC0,0x0a,0x8B,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 2 // 14 //
		    ///0xC0,0x04,0x4F,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 2 // 11 //
		    ///0xC0,0x06,0xD2,0x8A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 2 // 12 //
		    ///0xC0,0x08,0x16,0x4C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 2 // 13 //
		    ////0xC0,0x0a,0x8B,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 2 // 14 //
		    0xC0,0x04,0x4F,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 2 // 11 //
		    0xC0,0x06,0xD2,0x8A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 2 // 12 //
		    0xC0,0x08,0x16,0x4C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 2 // 13 //
		    0xC0,0x0a,0x8B,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 2 // 14 //
		    0xE0,0x04,0x96,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 3 // 15 //
		    0xE0,0x06,0x0B,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 3 // 16 //
		    0xE0,0x08,0xCF,0xD0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 3 // 17 //
		    0xE0,0x0a,0x52,0x86,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 3 // 18 //
		    ///0x80,0x04,0x77,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVA // 1 // 7 //
		    ///0x80,0x06,0xEA,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVB // 1 // 8 //
		    ///0x80,0x08,0x2E,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVC // 1 // 9 //
		    ///0x80,0x0a,0xB3,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDCVD // 1 // 10 //

		    0x85,0x60,0xA3,0xB4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCVAX // 1 // 19 //
		    0xC5,0x60,0x9B,0xbe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCVAX // 2 // 20 //
		    0x80,0x0c,0x9F,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXA // 1 // 21 //
		    0x80,0x0e,0x02,0x8E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXB // 1 // 22 //
		    0xC0,0x0c,0xA7,0xD2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXA // 2 // 23 //
		    0xC0,0x0e,0x3A,0x84,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXB // 2 // 24 //

		    0x83,0x78,0x37,0x58,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWU  // 1 // 25 ///
		    0xC3,0x78,0x0F,0x52,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWU  // 2 // 26 //
		    0xE3,0x78,0xD6,0xCE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWU  // 3 // 27 //

		    0x83,0x38,0xD0,0xD2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWD  // 1 // 28 //
		    0xC3,0x38,0xE8,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWD  // 2 // 29 //
		    0xE3,0x38,0x31,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADOWD  // 3 // 30 //

		    0xE5,0x60,0x42,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//ADCVAX // 3 // 31 //
		    0xE0,0x0c,0x7E,0x4E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXA // 3 // 32 //
		    0xE0,0x0e,0xE3,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//RDAUXB // 3 // 33 //

	};
/*volatile unsigned char SPIDATALEN2[33]=
	{
    //1 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
     12,12,12,04,04,04,12,12,12,12,12,12,12,12,12,12,12,12,04,04,12,12,12,12,04,04,04,04,04,04,04,12,12
	};*/


volatile unsigned char SPIDATALEN2[33]=
	{
    //1 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
     12,04,12,12,12,12,04,12,12,04,12,04,12,12,12,12,04,12,12,04,12,12,12,12,04,04,04,04,04,04,04,12,12
	};

unsigned short pec15(char *data , short len)
{
	short i;
	remainder = 16;		//PEC seed
	for (i = 0; i < len; i++)
	{
		address = ((remainder >> 7) ^ data[i]) & 0xff;		//calculate PEC table address
		remainder = (remainder << 8 ) ^ pec15Table[address];
	}
	return (remainder*2);	//The CRC15 has a 0 in the LSB so the final value must be multiplied by 2
}

//SPI_3  引脚初始化
void SPI_Pin_Init()
{
	//PD10 CS0
	//SIUL2.MSCR[PD10].B.SSS = 0b0100;//DSPI 3 select 0
	//SIUL2.MSCR[PD10].B.OBE = 1;
	//SIUL2.MSCR[PD10].B.SRC = 3;
	SIUL2.MSCR[PD11].B.SSS = 0b0011;//DSPI 3 select 1
	SIUL2.MSCR[PD11].B.OBE = 1;
	SIUL2.MSCR[PD11].B.SRC = 3;

	//PD6 SCK
	SIUL2.MSCR[PD6].B.SSS = 0b0100;//DSPI SCLK
	SIUL2.MSCR[PD6].B.OBE = 1;
	SIUL2.MSCR[PD6].B.SRC = 3;

	//PD5 SOUT
	SIUL2.MSCR[PD5].B.SSS = 0b0100;//DSPI 3 SOUT
	SIUL2.MSCR[PD5].B.OBE = 1;
	SIUL2.MSCR[PD5].B.SRC = 3;

	//PD7(临时配置，未用) SIN
	SIUL2.IMCR[50].B.SSS  = 0b0010;
	SIUL2.MSCR[PD7].B.IBE = 1;
	SIUL2.MSCR[PD7].B.PUE = 1;    //上拉/下拉使能
	SIUL2.MSCR[PD7].B.PUS = 1;    //配置为上拉

	SIUL2.MSCR[PD10].B.OBE = 1;	  //实际用到的
	SIUL2.GPDO[PD10].R  = 1;
#if slave_mode
	/* Slave - DSPI_2 */
	SIUL2.MSCR[PA0].B.SSS = 2;                /* Pad PA0: Source signal is DSPI_2 CLK */
	SIUL2.MSCR[PA0].B.IBE = 1;                /* Pad PA0: IBE=1. */
	SIUL2.IMCR[48].B.SSS = 1; 	           /* Pad PA0: DSPI_2 CLK. Slave takes clock from master. Therefore input */

	SIUL2.MSCR[PA1].B.SSS = 2;                /* Pad PA1: Source signal is DSPI_2 SOUT */
	SIUL2.MSCR[PA1].B.OBE = 1;                /* Pad PA1: OBE=1. */
	SIUL2.MSCR[PA1].B.SRC = 3;                /* Pad PA1: Full strength slew rate */

	SIUL2.MSCR[PA2].B.IBE = 1;                /* Pad PA2: Enable pad for input DSPI_2 SIN */
	SIUL2.IMCR[47].B.SSS = 2;            /* Pad PA2: connected to pad */

	SIUL2.MSCR[PA3].B.IBE = 1;                /* Pad PA3: IBE=1. DSPI_2 SS */
	SIUL2.IMCR[49].B.SSS = 1;            /* Pad PA3: connected to pad */
#endif
}
//SPI_3  功能寄存器初始化
void SPI_Init()
{
	SPI_3.MCR.R = 0x80010001;                //配置为主机,连续的CLK信号，防止数据的位出现错误
	//0xC0010001  PCS0高无效      0xC0000001  PCS0低无效

	SPI_3.MODE.CTAR[0].R = 0x3E021004;       //每帧8位，高位先发，波特率为Fp/80
	//0x3C021004 SCLK高无效    0x38021004  SCLK低无效
	//0x3C021004 CPHA=0

	SPI_3.MCR.B.HALT = 0x0;                  //开始发送
	//SPI_3.RSER.B.RFDF_RE = 0;                //中断不使能
	//SPI_3.RSER.B.RFDF_DIRS = 0;
	//INTC_0.PSR[290].R = 0x800B;
}

//SPI_3  数据接收函数
unsigned char SPI_DataRec()
{
	unsigned int RecDataMaster;
 	while (SPI_3.SR.B.RFDF != 1){}           //等待接收FIFO上溢，即：接收完数据
	RecDataMaster = SPI_3.POPR.R;            //读取主机接收到的数据
	SPI_3.SR.R = 0xFCFE0000;
	return RecDataMaster;
}

#if slave_mode
//SPI2  功能寄存器初始化
void SPI_Init2()
{
	SPI_2.MCR.R = 0x40010001;                //配置为主机,连续的CLK信号，防止数据的位出现错误
	SPI_2.MODE.CTAR[0].R = 0x3E021004;       //每帧8位，高位先发，波特率为Fp/80
	SPI_2.MCR.B.HALT = 0x0;                  //开始发送
	//SPI_2.RSER.B.RFDF_RE = 1;
	//SPI_2.RSER.B.RFDF_DIRS = 0;
	//INTC_0.PSR[281].R = 0x800B;
}
//SPI_2  数据接收函数
unsigned char SPI_DataRec2()
{
	unsigned char RecDataMaster;
 	while (SPI_2.SR.B.RFDF != 1){}           //等待接收FIFO上溢，即：接收完数据
	RecDataMaster = SPI_2.POPR.R;            //读取主机接收到的数据
	SPI_2.SR.R = 0xFCFE0000;
	return RecDataMaster;
}
#endif

//SPI_3  发送单个数据
uint8_t SPI_DataSend(uint8_t Data_Tx)
{
	uint8_t RecDataMaster;
	//SPI_3.SR.B.TCF = 1;    //将发送完成位清零
	//0x0801  为配置信息；0x5678为要发送的数据;CONT位不要轻易开，会出问题
	SPI_3.PUSHR.PUSHR.R  =  0x08020000 | (Data_Tx & 0x0000FFFF);     /* Transmit data from master to slave SPI with EOQ */
	//while(SPI_3.SR.B.TCF!=1); //Wait for transfer complete

	while (SPI_3.SR.B.RFDF != 1){}           //等待接收FIFO上溢，即：接收完数据
	RecDataMaster = SPI_3.POPR.R;            //读取主机接收到的数据
	SPI_3.SR.B.RFDF = 1;

	return RecDataMaster;
}

//SPI_3  发送单个数据
uint8_t SPI_mid_DataSend(uint8_t Data_Tx)
{
	uint8_t RecDataMaster;
	//SPI_3.SR.B.TCF = 1;    //将发送完成位清零
	//0x0801  为配置信息；0x5678为要发送的数据;CONT位不要轻易开，会出问题
	SPI_3.PUSHR.PUSHR.R  =  0x80020000 | (Data_Tx & 0x0000FFFF);     /* Transmit data from master to slave SPI with EOQ */
	//while(SPI_3.SR.B.TCF!=1); //Wait for transfer complete

	while (SPI_3.SR.B.RFDF != 1){}           //等待接收FIFO上溢，即：接收完数据
	RecDataMaster = SPI_3.POPR.R;            //读取主机接收到的数据
	SPI_3.SR.B.RFDF = 1;
	return RecDataMaster;
}

void DataOrganization()
{
	switch(gCommandType)
	{
		case WRCFG1://写配置寄存器1
		{
			SPILINE += 0;			//12
			gCommandType = ADCV1;
			sendable =1;
			break;
		}
		case ADCV1://测量电池电压1
		{
			SPILINE += 1;		//4
			gCommandType=SPIWAIT;
			sendable =1;
			break;
		}
		case SPIWAIT:
		{
			if (Waittime == 0)
			{
				gCommandType=RDCVA1;
				Waittime = 40;
			}
			else
			{
				Waittime--;
			}
			break;
		}
		case RDCVA1://读电池电压A1
		{
			SPILINE += 1;		//12
			//gCommandType=RDCVB1;
			gCommandType = RDCVB1;
			sendable =1;
			////ERR_LED_OFF;
			break;
		}
		case RDCVB1://读电池电压B1
		{
			SPILINE += 1;		//12
			gCommandType=RDCVC1;
			sendable =1;
			break;
		}
		case RDCVC1://读电池电压C1
		{
			SPILINE += 1;		//12
			gCommandType=RDCVD1;
			sendable =1;
			break;
		}
		case RDCVD1://读电池电压D1
		{
			SPILINE += 1;		//12
			gCommandType=ADCVAX1;
			sendable =1;
			break;
		}
		case ADCVAX1://启动组合电池电压以及GPIO转换和轮询状态
		{
			SPILINE += 1;		//4
			gCommandType=35;
			sendable =1;
			break;
		}
		case 35:
		{
			SPILINE = 9;
			gCommandType=SPIWAIT2;
			sendable =1;
			break;
		}
		case SPIWAIT2:
		{
			if (Waittime == 0)
			{
				gCommandType=RDAUXA1;
				Waittime = 30;
			}
			else
			{
				Waittime--;
			}
			break;
		}
		case RDAUXA1://读辅助寄存器A1
		{
			SPILINE += 1;
			gCommandType=RDAUXB1;
			sendable =1;
			break;
		}
		case RDAUXB1://读辅助寄存器B1
		{
			SPILINE += 1;
			gCommandType = SPIRESET;
			sendable =1;
			break;
		}
		case SPIRESET:
		{
			if (resettime == 0)
			{
				gCommandType=WRCFG1;
				resettime = 30000;
			}
			else
			{
				resettime--;
			}
			break;
		}
	}
}

void vol_sample(unsigned char Num_6804, int cell[][12])
{
	static int i=0,num = 0;
	static unsigned char temp=0;
	static unsigned char rows = 0;
	static int tmp[6] = {0};

	uint8_t recNum = 0;
	if(gCommandType == WRCFG1)
	{
		//确定命令数组的起始位置
		SPILINE = Num_6804 * NUM_COMMAND;
	}
	if(sendable == 0)
		DataOrganization();
	if(i<SPIDATALEN2[SPILINE] && sendable == 1)
	{
		if(temp != SPILINE)//此时为刷新步骤的接收报文序号
		{
			temp = SPILINE;
			rows = 0;
		}
		if(i == 0)	//开始发送， CS0拉低
		{
			SIUL2.GPDO[PD10].R  = 0;
			delay_test(1);
		}
		if(i < SPIDATALEN2[SPILINE]-1)	//正在发送，非最后一个字节
			recNum = SPI_mid_DataSend(SPIDATA2[SPILINE][i++]);
		else if(i == SPIDATALEN2[SPILINE]-1)	//正在发送，最后一个字节
			recNum = SPI_DataSend(SPIDATA2[SPILINE][i++]);
		if(i == SPIDATALEN2[SPILINE])	//发送完成， CS0拉高
		{
			delay_test(1);
			SIUL2.GPDO[PD10].R  = 1;
		}
		g_SPI_Rx_array[temp][rows++] = recNum;
	}
	else if(i==SPIDATALEN2[SPILINE])
	{
		//清零， 以DataOrganization()函数继续执行指令
		sendable =0;
		i=0;
	}
	//RESET时读取数据
	if(gCommandType == SPIRESET)
	{
	//g_SPI_Rx_array[temp][rows] = 1;
		char limit = 6 + Num_6804*NUM_COMMAND;
		char index_t = 2 + Num_6804*NUM_COMMAND;
		for(num=index_t; num<limit; num++)
		{
			cell[Num_6804][(num-index_t)*3] =  ((unsigned short)(g_SPI_Rx_array[num][5]) << 8) + (unsigned short)g_SPI_Rx_array[num][4];
			cell[Num_6804][(num-index_t)*3+1] =  ((unsigned short)(g_SPI_Rx_array[num][7]) << 8) + (unsigned short)g_SPI_Rx_array[num][6];
			cell[Num_6804][(num-index_t)*3+2] =  ((unsigned short)(g_SPI_Rx_array[num][9]) << 8) + (unsigned short)g_SPI_Rx_array[num][8];
		}
		limit = 9 + Num_6804*NUM_COMMAND;
		index_t = 7+Num_6804*NUM_COMMAND;
		for(num=7+Num_6804*NUM_COMMAND; num < limit; num++)
		{
			tmp[(num-index_t)*3] =  ((unsigned short)(g_SPI_Rx_array[num][5]) << 8) + (unsigned short)g_SPI_Rx_array[num][4];
			tmp[(num-index_t)*3+1] =  ((unsigned short)(g_SPI_Rx_array[num][7]) << 8) + (unsigned short)g_SPI_Rx_array[num][6];
			tmp[(num-index_t)*3+2] =  ((unsigned short)(g_SPI_Rx_array[num][9]) << 8) + (unsigned short)g_SPI_Rx_array[num][8];
		}
		cell;
	}
}

void delay_test(unsigned char t)
{
	int i,j;
	j=50000;
	for(i=0;i<t;i++)
	{
		while(j > 0)
			j--;
	}
}
